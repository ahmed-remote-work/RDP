name: SSH Ubuntu Access

on:
  workflow_dispatch:

jobs:
  secure-ssh:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Configure SSH Settings
        run: |
          # Enable SSH service
          sudo systemctl enable ssh
          sudo systemctl start ssh
          
          # Configure SSH for security
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config
          
          # Restart SSH service to apply changes
          sudo systemctl restart ssh
          
          # Configure firewall to allow SSH (port 22)
          sudo ufw allow 22/tcp
          sudo ufw --force enable

      - name: Create SSH User with Secure Password
        run: |
          # Generate secure random password
          password=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-25)
          
          # Create user with sudo privileges
          sudo useradd -m -s /bin/bash -G sudo ssh-user
          echo "ssh-user:$password" | sudo chpasswd
          
          # Ensure user can sudo without password for convenience
          echo "ssh-user ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/ssh-user
          
          # Store credentials in environment
          echo "SSH_CREDS=User: ssh-user | Password: $password" >> $GITHUB_ENV
          
          # Verify user creation
          if ! id ssh-user &>/dev/null; then
              echo "User creation failed"
              exit 1
          fi

      - name: Install Tailscale
        run: |
          # Add Tailscale repository
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg > /dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          
          # Update package list and install Tailscale
          sudo apt-get update
          sudo apt-get install -y tailscale

      - name: Establish Tailscale Connection
        run: |
          # Bring up Tailscale with the provided auth key and set a unique hostname
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-ubuntu-runner-$GITHUB_RUN_ID
          
          # Wait for Tailscale to assign an IP
          retries=0
          while [ $retries -lt 10 ]; do
              tsip=$(tailscale ip -4 2>/dev/null)
              if [ -n "$tsip" ]; then
                  echo "TAILSCALE_IP=$tsip" >> $GITHUB_ENV
                  break
              fi
              sleep 5
              retries=$((retries + 1))
          done
          
          if [ -z "$tsip" ]; then
              echo "Tailscale IP not assigned. Exiting."
              exit 1
          fi
      
      - name: Verify SSH Accessibility
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          
          # Test SSH connectivity
          if nc -zv $TAILSCALE_IP 22 2>&1 | grep -q "succeeded"; then
              echo "SSH connectivity test successful!"
          else
              echo "SSH connection test failed"
              exit 1
          fi

      - name: Install Additional Tools (Optional)
        run: |
          # Install useful tools for remote work
          sudo apt-get update
          sudo apt-get install -y \
            htop \
            neofetch \
            git \
            curl \
            wget \
            vim \
            tmux \
            tree \
            unzip
          
          # Display system info
          neofetch

      - name: Maintain Connection
        run: |
          echo ""
          echo "=== SSH ACCESS ==="
          echo "Address: $TAILSCALE_IP"
          echo "Port: 22"
          echo "Username: ssh-user"
          echo "Password: $(echo $SSH_CREDS | cut -d'|' -f2 | cut -d':' -f2 | xargs)"
          echo "=================="
          echo ""
          echo "Connect using: ssh ssh-user@$TAILSCALE_IP"
          echo ""
          
          # Keep runner active indefinitely (or until manually cancelled)
          while true; do
              echo "[$(date)] SSH Active - Use Ctrl+C in workflow to terminate"
              sleep 300
          done
